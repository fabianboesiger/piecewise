name: github pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        profile: minimal
        target: wasm32-unknown-unknown
        override: true

    - uses: Swatinem/rust-cache@v2

    - name: Update Project Dependencies
      shell: bash
      run: cargo update --locked

    - name: Install Dioxus-CLI
      shell: bash
      run: cargo install dioxus-cli --locked

    - name: Build Project
      shell: bash
      run: dx build --release --platform web

    - name: Build Project for MacOS
      shell: bash
      run: dx build --release --platform macos

    - name: Build Project for Windows
      shell: bash
      run: dx build --release --platform windows

    - name: Build Project for Linux
      shell: bash
      run: dx build --release --platform linux

    - name: Copy Releases to Public Directory
      shell: bash
      run: |
        mkdir -p target/dx/piecewise/release/web/public/releases/macos
        mkdir -p target/dx/piecewise/release/web/public/releases/windows
        mkdir -p target/dx/piecewise/release/web/public/releases/linux
        cp target/dx/piecewise/release/macos/Piecewise target/dx/piecewise/release/web/public/releases/macos/
        cp target/dx/piecewise/release/windows/Piecewise.exe target/dx/piecewise/release/web/public/releases/windows/
        cp target/dx/piecewise/release/linux/Piecewise target/dx/piecewise/release/web/public/releases/linux/

    - name: Deploy Project
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: gh-pages
        folder: target/dx/piecewise/release/web/public
        clean: false
